<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/Transparent-Transactions/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transparent Transactions</title>
    <meta name="description" content="Secure P2P transaction tracking with mutual consent">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- App Modules -->
    <script src="db.js" defer></script>
    <script src="auth.js" defer></script>
    <script src="contacts.js" defer></script>
    <script src="transactions.js" defer></script>
    <script src="ui.js" defer></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen active">
        <div class="loading-container">
            <div class="logo">‚Çπ</div>
            <h1>Transparent Transactions</h1>
            <p>Loading your secure ledger...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <div class="app-header">
                <div class="logo">‚Çπ</div>
                <h1>Transparent Transactions</h1>
                <p class="tagline">Track payments with mutual trust</p>
            </div>
            
            <div class="features-list">
                <div class="feature">
                    <span class="feature-icon">ü§ù</span>
                    <span>Mutual transaction approval</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">üîí</span>
                    <span>Your data stays private</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">üì±</span>
                    <span>Works completely offline</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">üáÆüá≥</span>
                    <span>Made for Rural India</span>
                </div>
            </div>

            <div class="auth-section">
                <p class="auth-info">Enter your mobile number to get started</p>
                
                <div class="phone-input-container">
                    <div class="country-code">+91</div>
                    <input 
                        type="tel" 
                        id="phoneInput" 
                        placeholder="Enter 10-digit mobile number" 
                        maxlength="10"
                        inputmode="numeric"
                        pattern="[0-9]{10}"
                    >
                </div>
                
                <button id="sendOtpBtn" class="btn-primary full-width">
                    Send OTP via SMS
                </button>

                <div id="otpSection" class="hidden">
                    <p class="otp-info">We've sent a 6-digit OTP to your number</p>
                    
                    <div class="otp-input-container">
                        <input 
                            type="tel" 
                            id="otpInput" 
                            placeholder="Enter 6-digit OTP" 
                            maxlength="6"
                            inputmode="numeric"
                            pattern="[0-9]{6}"
                        >
                    </div>
                    
                    <div class="otp-actions">
                        <button id="verifyOtpBtn" class="btn-primary">
                            Verify OTP
                        </button>
                        <button id="resendOtpBtn" class="btn-outline">
                            Resend OTP
                        </button>
                    </div>
                    
                    <div id="otpTimer" class="otp-timer hidden">
                        Resend OTP in <span id="timerCount">60</span> seconds
                    </div>
                </div>

                <div id="authStatus" class="auth-status hidden">
                    <!-- Status messages will appear here -->
                </div>
            </div>

            <div class="privacy-notice">
                <p>Your phone number is only used for authentication. 
                   We never share your data.
                   <a href="#privacy" onclick="showPrivacyInfo()">Learn more</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" class="screen">
        <header class="app-header-bar">
            <div class="header-left">
                <h2>My Ledger</h2>
                <span id="userGreeting">Hello!</span>
            </div>
            <div class="header-right">
                <button id="notificationsBtn" class="icon-btn" aria-label="Notifications">
                    üîî
                    <span id="notificationCount" class="notification-badge hidden">0</span>
                </button>
                <button id="userMenuBtn" class="user-avatar" aria-label="User menu">
                    <div id="userAvatar" class="avatar-placeholder">üë§</div>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="app-nav">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="contacts">Contacts</button>
            <button class="nav-tab" data-tab="transactions">Transactions</button>
            <button class="nav-tab" data-tab="reports">Reports</button>
        </nav>

        <!-- Main Content Area -->
        <main class="app-main">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="user-welcome">
                    <h3 id="userWelcomeText">Welcome!</h3>
                    <p id="userPhoneDisplay" class="user-phone"></p>
                </div>

                <div class="balance-overview">
                    <div class="balance-card net-balance">
                        <h3>Net Balance</h3>
                        <div id="netBalance" class="balance-amount">‚Çπ0</div>
                        <div id="balanceTrend" class="balance-trend">No transactions yet</div>
                    </div>
                    <div class="balance-stats">
                        <div class="stat-item">
                            <span class="stat-label">You'll Receive</span>
                            <span id="totalReceivable" class="stat-amount positive">‚Çπ0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">You'll Pay</span>
                            <span id="totalPayable" class="stat-amount negative">‚Çπ0</span>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        <button id="addTransactionBtn" class="action-btn primary">
                            <span class="btn-icon">‚ûï</span>
                            New Transaction
                        </button>
                        <button id="addContactBtn" class="action-btn secondary">
                            <span class="btn-icon">üë§</span>
                            Add Contact
                        </button>
                        <button id="creditTransferBtn" class="action-btn secondary">
                            <span class="btn-icon">üîÑ</span>
                            Transfer Credit
                        </button>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div id="recentActivityList" class="activity-list">
                        <div class="empty-state">
                            <p>No transactions yet</p>
                            <button id="firstTransactionBtn" class="btn-outline small">
                                Create your first transaction
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contacts Tab -->
            <div id="contactsTab" class="tab-content">
                <div class="contacts-header">
                    <h3>My Business Contacts</h3>
                    <button id="importContactsBtn" class="btn-outline">
                        üìû Import from Phone
                    </button>
                </div>
                <div id="contactsList" class="contacts-list">
                    <div class="empty-state">
                        <p>No contacts yet</p>
                        <button id="firstContactBtn" class="btn-outline small">
                            Add your first contact
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsTab" class="tab-content">
                <div class="transactions-header">
                    <h3>All Transactions</h3>
                    <div class="filter-options">
                        <select id="transactionFilter">
                            <option value="all">All Transactions</option>
                            <option value="pending">Pending Approval</option>
                            <option value="approved">Approved</option>
                            <option value="sent">Sent by Me</option>
                            <option value="received">Received by Me</option>
                        </select>
                    </div>
                </div>
                <div id="transactionsList" class="transactions-list">
                    <div class="empty-state">
                        <p>No transactions yet</p>
                        <button id="firstTransactionBtn2" class="btn-outline small">
                            Create your first transaction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content">
                <div class="reports-header">
                    <h3>Financial Reports</h3>
                    <button id="generateReportBtn" class="btn-primary">
                        üìä Generate Report
                    </button>
                </div>
                <div id="reportsContent" class="reports-content">
                    <div class="empty-state">
                        <p>No report data available</p>
                        <p class="hint">Create some transactions to generate reports</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- User Menu Dropdown -->
        <div id="userMenu" class="dropdown-menu hidden">
            <div class="menu-item" onclick="showProfile()">
                <span class="menu-icon">üë§</span>
                My Profile
            </div>
            <div class="menu-item" onclick="exportData()">
                <span class="menu-icon">üì§</span>
                Export Data
            </div>
            <div class="menu-item" onclick="showSettings()">
                <span class="menu-icon">‚öôÔ∏è</span>
                Settings
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item logout" onclick="logout()">
                <span class="menu-icon">üö™</span>
                Sign Out
            </div>
        </div>
    </div>

    <!-- Modals will be added by JavaScript -->
    <div id="modalsContainer"></div>

    <!-- App Initialization -->
    <script>
        // Global app state
        window.appState = {
            currentUser: null,
            isOnline: navigator.onLine,
            dbInitialized: false
        };

        // Initialize app when everything is loaded
        window.addEventListener('load', async function() {
            console.log('üöÄ Starting app initialization...');
            
            try {
                // Wait for all scripts to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check if all modules are loaded
                if (!window.transparentDB) {
                    throw new Error('Database module not loaded');
                }
                if (!window.authManager) {
                    throw new Error('Auth module not loaded');
                }
                if (!window.uiManager) {
                    throw new Error('UI module not loaded');
                }

                console.log('‚úÖ All modules loaded, initializing database...');
                
                // Initialize database
                await transparentDB.init();
                window.appState.dbInitialized = true;
                console.log('‚úÖ Database initialized');

                // Initialize auth manager
                await authManager.init();
                console.log('‚úÖ Auth manager initialized');

                // Check for existing user session
                const savedUser = await authManager.getCurrentUser();
                if (savedUser) {
                    console.log('‚úÖ Found existing user:', savedUser.phone);
                    await uiManager.showAppScreen(savedUser);
                } else {
                    console.log('‚ÑπÔ∏è No existing session, showing login');
                    await uiManager.showLoginScreen();
                }

                // Hide loading screen
                document.getElementById('loadingScreen').classList.remove('active');
                console.log('üéâ App initialized successfully!');

            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
                document.getElementById('loadingScreen').classList.remove('active');
                
                let errorMessage = 'Failed to initialize app. ';
                if (error.message.includes('Database')) {
                    errorMessage += 'Please check if your browser supports IndexedDB.';
                } else if (error.message.includes('module')) {
                    errorMessage += 'Some files failed to load. Please refresh.';
                } else {
                    errorMessage += 'Please refresh the page.';
                }
                
                if (window.uiManager) {
                    uiManager.showError(errorMessage);
                } else {
                    alert(errorMessage);
                }
            }
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            window.appState.isOnline = true;
            if (window.uiManager) uiManager.showStatus('Back online', 'success');
        });

        window.addEventListener('offline', () => {
            window.appState.isOnline = false;
            if (window.uiManager) uiManager.showStatus('Working offline', 'warning');
        });

        // Simple privacy info
        window.showPrivacyInfo = function() {
            alert(`Privacy Information:\n\n‚Ä¢ We only store your phone number for authentication\n‚Ä¢ All transaction data stays on your device\n‚Ä¢ We never share your data with anyone\n‚Ä¢ You can export or delete your data anytime\n‚Ä¢ No personal information is collected without your consent`);
        };
    </script>
    <script>
    // ‚úÖ Handle PWA routing - redirect any invalid routes to main app
    if (window.location.pathname !== '/' && !window.location.pathname.endsWith('.html')) {
        window.history.replaceState(null, null, '/');
    }
    
    // ‚úÖ Handle GitHub Pages 404 redirects
    if (sessionStorage.redirect) {
        sessionStorage.removeItem('redirect');
    }
</script>
</body>
</html>
