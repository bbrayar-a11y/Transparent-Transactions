<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Transparent Transactions</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <style>
        .referral-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .referral-link-container {
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .referral-link {
            font-family: monospace;
            font-size: 16px;
            word-break: break-all;
            margin: 10px 0;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .network-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .network-stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .network-stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .network-stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .commission-stats {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .commission-level {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .commission-level:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .network-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Loading Dashboard</h3>
            <p>Please wait while we verify your session...</p>
        </div>
    </div>

    <!-- Main App (initially hidden) -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>Transparent Transactions</h1>
                    <div class="online-indicator" id="onlineIndicator">
                        <span class="indicator-dot"></span>
                        <span class="indicator-text">Online</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-phone" id="userPhone"></span>
                    </div>
                    <button class="btn-logout" onclick="handleLogout()">üö™ Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="container">
                <!-- Welcome Section -->
                <section class="welcome-section">
                    <div class="welcome-card">
                        <h2>üéâ Welcome back, <span id="welcomeName">User</span>!</h2>
                        <p>Your account is active and ready for transactions</p>
                        <div class="member-since">
                            Member since: <span id="memberSince">Loading...</span>
                        </div>
                    </div>
                </section>

                <!-- Referral Network Section -->
                <section class="referral-section" id="referralSection">
                    <h3>üéØ Your Trust Network</h3>
                    <p>Grow your network and earn commissions</p>
                    
                    <!-- Personal Referral Link -->
                    <div class="referral-link-container">
                        <h4>üîó Your Personal Referral Link</h4>
                        <div class="referral-link" id="personalReferralLink">
                            Loading your referral link...
                        </div>
                        <button class="btn btn-primary" onclick="copyReferralLink()" style="margin-right: 10px;">
                            üìã Copy Link
                        </button>
                        <button class="btn btn-secondary" onclick="shareReferralLink()">
                            üì§ Share
                        </button>
                    </div>

                    <!-- Network Statistics -->
                    <div class="network-stats-grid" id="networkStats">
                        <div class="network-stat-card">
                            <div class="network-stat-number" id="directReferrals">0</div>
                            <div class="network-stat-label">Direct Referrals</div>
                        </div>
                        <div class="network-stat-card">
                            <div class="network-stat-number" id="level2Referrals">0</div>
                            <div class="network-stat-label">Level 2 Network</div>
                        </div>
                        <div class="network-stat-card">
                            <div class="network-stat-number" id="level3Referrals">0</div>
                            <div class="network-stat-label">Level 3 Network</div>
                        </div>
                        <div class="network-stat-card">
                            <div class="network-stat-number" id="totalNetwork">0</div>
                            <div class="network-stat-label">Total Network</div>
                        </div>
                    </div>

                    <!-- Commission Structure -->
                    <div class="commission-stats">
                        <h4>üí∞ Commission Structure</h4>
                        <div class="commission-level">
                            <span>Level 1 (Direct):</span>
                            <strong>‚Çπ1.60 per ‚Çπ10</strong>
                        </div>
                        <div class="commission-level">
                            <span>Level 2:</span>
                            <strong>‚Çπ0.80 per ‚Çπ10</strong>
                        </div>
                        <div class="commission-level">
                            <span>Level 3:</span>
                            <strong>‚Çπ0.40 per ‚Çπ10</strong>
                        </div>
                        <div class="commission-level">
                            <span>Level 4:</span>
                            <strong>‚Çπ0.20 per ‚Çπ10</strong>
                        </div>
                    </div>
                </section>

                <!-- Quick Stats -->
                <section class="stats-section">
                    <h3>Your Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <h4>Account Balance</h4>
                                <p class="stat-amount" id="balanceAmount">‚Çπ0.00</p>
                                <small>Available funds</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <h4>Trust Score</h4>
                                <p class="stat-amount" id="trustScore">100%</p>
                                <small>Reputation level</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üîÑ</div>
                            <div class="stat-content">
                                <h4>Total Transactions</h4>
                                <p class="stat-amount" id="transactionsCount">0</p>
                                <small>All time</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-content">
                                <h4>Contacts</h4>
                                <p class="stat-amount" id="contactsCount">0</p>
                                <small>Trusted users</small>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quick Actions -->
                <section class="actions-section">
                    <h3>Quick Actions</h3>
                    <div class="actions-grid">
                        <button class="action-card" onclick="sendMoney()">
                            <div class="action-icon">üí∏</div>
                            <div class="action-text">Send Money</div>
                        </button>
                        
                        <button class="action-card" onclick="addContact()">
                            <div class="action-icon">üë§</div>
                            <div class="action-text">Add Contact</div>
                        </button>
                        
                        <button class="action-card" onclick="showReferral()">
                            <div class="action-icon">üéØ</div>
                            <div class="action-text">Referral Code</div>
                        </button>
                        
                        <button class="action-card" onclick="viewProfile()">
                            <div class="action-icon">üë®‚Äçüíº</div>
                            <div class="action-text">My Profile</div>
                        </button>
                    </div>
                </section>

                <!-- Recent Activity -->
                <section class="activity-section">
                    <div class="section-header">
                        <h3>Recent Activity</h3>
                        <button class="btn-link" onclick="viewAllActivity()">View All</button>
                    </div>
                    
                    <div class="activity-list" id="activityList">
                        <div class="empty-state">
                            <p>No recent activity</p>
                            <small>Your transactions will appear here</small>
                        </div>
                    </div>
                </section>

                <!-- Debug Panel (for testing) -->
                <section class="debug-section" id="debugSection">
                    <div class="section-header">
                        <h4>üîß Debug Information</h4>
                        <button class="btn-link" onclick="toggleDebug()">Hide</button>
                    </div>
                    
                    <div class="debug-content" id="debugContent">
                        <div class="debug-grid">
                            <div class="debug-item">
                                <label>Session Status:</label>
                                <span id="debugSessionStatus">Checking...</span>
                            </div>
                            <div class="debug-item">
                                <label>User Phone:</label>
                                <span id="debugUserPhone">Loading...</span>
                            </div>
                            <div class="debug-item">
                                <label>Login Time:</label>
                                <span id="debugLoginTime">Loading...</span>
                            </div>
                            <div class="debug-item">
                                <label>Database Status:</label>
                                <span id="debugDbStatus">Checking...</span>
                            </div>
                            <div class="debug-item">
                                <label>Referral Code:</label>
                                <span id="debugReferralCode">Loading...</span>
                            </div>
                            <div class="debug-item">
                                <label>Referred By:</label>
                                <span id="debugReferredBy">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="debug-actions">
                            <button class="btn btn-info" onclick="checkSession()">üîç Check Session</button>
                            <button class="btn btn-info" onclick="refreshData()">üîÑ Refresh Data</button>
                            <button class="btn btn-warning" onclick="clearData()">üßπ Clear Data</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="container">
                <p>&copy; 2024 Transparent Transactions. Secure & Transparent Money Transfers.</p>
            </div>
        </footer>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Scripts in correct order -->
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Dashboard state
        let dashboardData = {
            user: null,
            stats: null,
            activities: [],
            networkStats: null
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üè† Dashboard initializing...');
            
            try {
                // Wait for essential components
                await waitForComponents();
                
                // Validate user session
                await validateAndLoadSession();
                
            } catch (error) {
                console.error('üí• Dashboard initialization failed:', error);
                showFatalError('Failed to load dashboard. Please try again.');
            }
        });

        // Wait for essential components to be ready
        async function waitForComponents() {
            const maxWaitTime = 10000; // 10 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
                if (window.databaseManager && window.databaseManager.isInitialized && 
                    window.authManager && window.authManager.isInitialized) {
                    console.log('‚úÖ All components ready');
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            throw new Error('Components not ready within timeout');
        }

        // Validate session and load data
        async function validateAndLoadSession() {
            try {
                // Check if user is authenticated
                if (!window.authManager.isAuthenticated()) {
                    throw new Error('No active session');
                }

                // Get current user from localStorage
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    throw new Error('No user session found');
                }

                dashboardData.user = JSON.parse(currentUser);
                console.log('‚úÖ Session validated:', dashboardData.user.phone);
                
                // Load dashboard data
                await loadDashboardData();
                
                // Show main app
                showAppInterface();
                
                // Update debug info
                updateDebugInfo();
                
            } catch (error) {
                console.error('‚ùå Session validation failed:', error);
                handleSessionError(error.message);
            }
        }

        // Load all dashboard data
        async function loadDashboardData() {
            try {
                showLoadingMessage('Loading your data...');
                
                // Load user stats
                await loadUserStats();
                
                // Load referral network stats
                await loadReferralNetworkStats();
                
                // Load recent activity
                await loadRecentActivity();
                
                // Update UI
                updateDashboardUI();
                
                // Hide loading
                hideLoadingScreen();
                
            } catch (error) {
                console.error('‚ùå Data loading failed:', error);
                showNotification('warning', 'Data Loading', 'Some data may not be current');
            }
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                const userPhone = dashboardData.user.phone;
                
                // Get user profile for latest data
                const userProfile = await window.databaseManager.getUser(userPhone);
                if (userProfile) {
                    dashboardData.user.profile = userProfile;
                }
                
                // Calculate basic stats
                const transactions = await window.databaseManager.getUserTransactions(userPhone);
                const contacts = await window.databaseManager.getContacts(userPhone);
                const commissions = await window.databaseManager.getUserCommissions(userPhone);
                
                dashboardData.stats = {
                    balance: userProfile?.balance || 0,
                    trustScore: userProfile?.trustScore || 100,
                    transactionsCount: transactions.length,
                    contactsCount: contacts.length,
                    totalEarnings: commissions.filter(c => c.status === 'paid')
                                           .reduce((sum, c) => sum + (c.amount || 0), 0)
                };
                
            } catch (error) {
                console.error('‚ùå Stats loading error:', error);
                // Set default stats
                dashboardData.stats = {
                    balance: 0,
                    trustScore: 100,
                    transactionsCount: 0,
                    contactsCount: 0,
                    totalEarnings: 0
                };
            }
        }

        // Load referral network statistics
        async function loadReferralNetworkStats() {
            try {
                const userPhone = dashboardData.user.phone;
                
                // Get network stats from database
                if (window.databaseManager.getUserNetworkStats) {
                    dashboardData.networkStats = await window.databaseManager.getUserNetworkStats(userPhone);
                } else {
                    // Fallback if method not available
                    dashboardData.networkStats = {
                        directReferrals: 0,
                        level2Referrals: 0,
                        level3Referrals: 0,
                        level4Referrals: 0,
                        totalNetwork: 0
                    };
                }
                
            } catch (error) {
                console.error('‚ùå Network stats loading error:', error);
                dashboardData.networkStats = {
                    directReferrals: 0,
                    level2Referrals: 0,
                    level3Referrals: 0,
                    level4Referrals: 0,
                    totalNetwork: 0
                };
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const userPhone = dashboardData.user.phone;
                const transactions = await window.databaseManager.getUserTransactions(userPhone);
                
                // Get last 5 transactions, sorted by date
                dashboardData.activities = transactions
                    .sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate))
                    .slice(0, 5)
                    .map(tx => ({
                        type: 'transaction',
                        id: tx.id,
                        amount: tx.amount,
                        description: tx.description,
                        date: tx.createdDate,
                        status: tx.status,
                        isIncoming: tx.toPhone === userPhone
                    }));
                    
            } catch (error) {
                console.error('‚ùå Activity loading error:', error);
                dashboardData.activities = [];
            }
        }

        // Update dashboard UI with loaded data
        function updateDashboardUI() {
            if (!dashboardData.user || !dashboardData.stats) return;
            
            // User info
            document.getElementById('userName').textContent = 
                dashboardData.user.profile?.fullName || 'User';
            document.getElementById('userPhone').textContent = 
                formatPhone(dashboardData.user.phone);
            document.getElementById('welcomeName').textContent = 
                dashboardData.user.profile?.fullName || 'there';
            document.getElementById('memberSince').textContent = 
                new Date(dashboardData.user.profile?.createdAt || Date.now()).toLocaleDateString();
            
            // Stats
            document.getElementById('balanceAmount').textContent = 
                formatCurrency(dashboardData.stats.balance);
            document.getElementById('trustScore').textContent = 
                `${dashboardData.stats.trustScore}%`;
            document.getElementById('transactionsCount').textContent = 
                dashboardData.stats.transactionsCount.toString();
            document.getElementById('contactsCount').textContent = 
                dashboardData.stats.contactsCount.toString();
            
            // Referral Network
            updateReferralNetworkUI();
            
            // Recent activity
            updateActivityList();
            
            // Online indicator
            updateOnlineStatus();
        }

        // Update referral network UI
        function updateReferralNetworkUI() {
            // Personal referral link
            const referralCode = dashboardData.user.profile?.myReferralCode || generateReferralCode();
            const baseUrl = window.location.origin + window.location.pathname;
            const referralLink = `${baseUrl.replace('dashboard.html', '')}login.html?ref=${referralCode}`;
            
            document.getElementById('personalReferralLink').textContent = referralLink;
            
            // Network statistics
            if (dashboardData.networkStats) {
                document.getElementById('directReferrals').textContent = 
                    dashboardData.networkStats.directReferrals;
                document.getElementById('level2Referrals').textContent = 
                    dashboardData.networkStats.level2Referrals;
                document.getElementById('level3Referrals').textContent = 
                    dashboardData.networkStats.level3Referrals;
                document.getElementById('totalNetwork').textContent = 
                    dashboardData.networkStats.totalNetwork;
            }
        }

        // Update activity list
        function updateActivityList() {
            const activityList = document.getElementById('activityList');
            
            if (dashboardData.activities.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <p>No recent activity</p>
                        <small>Your transactions will appear here</small>
                    </div>
                `;
                return;
            }
            
            activityList.innerHTML = dashboardData.activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">
                        ${activity.isIncoming ? 'üì•' : 'üì§'}
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">
                            ${activity.isIncoming ? 'Received' : 'Sent'} Money
                        </div>
                        <div class="activity-description">
                            ${activity.description || 'Transaction'}
                        </div>
                        <div class="activity-date">
                            ${new Date(activity.date).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="activity-amount ${activity.isIncoming ? 'positive' : 'negative'}">
                        ${activity.isIncoming ? '+' : '-'}${formatCurrency(activity.amount)}
                    </div>
                </div>
            `).join('');
        }

        // Show main app interface
        function showAppInterface() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            showNotification('success', 'Welcome Back', 
                `Good to see you, ${dashboardData.user.profile?.fullName || 'there'}!`);
        }

        // Handle session errors
        function handleSessionError(errorMessage) {
            hideLoadingScreen();
            
            const errorHtml = `
                <div class="error-screen">
                    <div class="error-content">
                        <h2>üîê Session Error</h2>
                        <p>${errorMessage}</p>
                        <div class="error-actions">
                            <button class="btn btn-primary" onclick="goToLogin()">
                                Go to Login
                            </button>
                            <button class="btn btn-secondary" onclick="retryInitialization()">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.innerHTML = errorHtml;
        }

        // Show fatal error
        function showFatalError(message) {
            hideLoadingScreen();
            
            const errorHtml = `
                <div class="error-screen">
                    <div class="error-content">
                        <h2>üí• Application Error</h2>
                        <p>${message}</p>
                        <div class="error-actions">
                            <button class="btn btn-primary" onclick="window.location.reload()">
                                Reload Application
                            </button>
                            <button class="btn btn-secondary" onclick="goToLogin()">
                                Go to Login
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.innerHTML = errorHtml;
        }

        // REFERRAL SYSTEM FUNCTIONS

        function copyReferralLink() {
            const referralLink = document.getElementById('personalReferralLink').textContent;
            
            navigator.clipboard.writeText(referralLink).then(() => {
                showNotification('success', 'Copied!', 'Referral link copied to clipboard');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = referralLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('success', 'Copied!', 'Referral link copied to clipboard');
            });
        }

        function shareReferralLink() {
            const referralLink = document.getElementById('personalReferralLink').textContent;
            const message = `Join me on TrustChain! Use my referral link: ${referralLink}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join TrustChain',
                    text: message,
                    url: referralLink
                }).catch(error => {
                    console.log('Share cancelled:', error);
                });
            } else {
                // Fallback - copy to clipboard with instructions
                copyReferralLink();
                showNotification('info', 'Share', 'Link copied! Share it via WhatsApp, SMS, or other apps');
            }
        }

        // ACTION HANDLERS

        async function handleLogout() {
            try {
                showLoadingMessage('Logging out...');
                
                await window.authManager.logout();
                
                showNotification('success', 'Logged Out', 'You have been signed out successfully');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Logout error:', error);
                // Force logout anyway
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        function sendMoney() {
            showNotification('info', 'Send Money', 'This feature will be available soon!');
            // TODO: Implement send money flow
        }

        function addContact() {
            showNotification('info', 'Add Contact', 'This feature will be available soon!');
            // TODO: Implement add contact flow
        }

        function showReferral() {
            const referralLink = document.getElementById('personalReferralLink').textContent;
            showNotification('success', 'Your Referral Link', 
                `Share this link with friends:\n${referralLink}\n\nEarn commissions when they join!`);
        }

        function viewProfile() {
            showNotification('info', 'Profile', 'Profile section coming soon!');
            // TODO: Navigate to profile page
        }

        function viewAllActivity() {
            showNotification('info', 'Activity', 'Full activity history coming soon!');
            // TODO: Navigate to transactions page
        }

        // DEBUG FUNCTIONS

        function toggleDebug() {
            const debugContent = document.getElementById('debugContent');
            const toggleBtn = document.querySelector('#debugSection .btn-link');
            
            if (debugContent.style.display === 'none') {
                debugContent.style.display = 'block';
                toggleBtn.textContent = 'Hide';
            } else {
                debugContent.style.display = 'none';
                toggleBtn.textContent = 'Show';
            }
        }

        function updateDebugInfo() {
            if (!dashboardData.user) return;
            
            document.getElementById('debugSessionStatus').textContent = 'Valid';
            document.getElementById('debugSessionStatus').className = 'status-valid';
            document.getElementById('debugUserPhone').textContent = dashboardData.user.phone;
            document.getElementById('debugLoginTime').textContent = 
                new Date(dashboardData.user.loginTime).toLocaleString();
            document.getElementById('debugDbStatus').textContent = 
                window.databaseManager.isInitialized ? 'Connected' : 'Disconnected';
            document.getElementById('debugDbStatus').className = 
                window.databaseManager.isInitialized ? 'status-valid' : 'status-error';
            document.getElementById('debugReferralCode').textContent = 
                dashboardData.user.profile?.myReferralCode || 'Not set';
            document.getElementById('debugReferredBy').textContent = 
                dashboardData.user.profile?.referredBy || 'Direct signup';
        }

        async function checkSession() {
            try {
                showNotification('success', 'Session Check', 'Session is valid');
                updateDebugInfo();
            } catch (error) {
                showNotification('error', 'Session Check Failed', error.message);
            }
        }

        async function refreshData() {
            showLoadingMessage('Refreshing data...');
            await loadDashboardData();
            showNotification('success', 'Data Refreshed', 'Your dashboard has been updated');
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all local data? This will log you out.')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // UTILITY FUNCTIONS

        function showLoadingMessage(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.querySelector('p').textContent = message;
            }
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }

        function showNotification(type, title, message) {
            // Use app.js notification system if available
            if (window.app && window.app.showNotification) {
                window.app.showNotification({ type, title, message });
                return;
            }
            
            // Fallback notification system
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;
            
            const container = document.getElementById('notificationContainer');
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatPhone(phone) {
            return phone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        }

        function generateReferralCode() {
            const phone = dashboardData.user.phone;
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const randomPart = Array(4).fill().map(() => 
                chars.charAt(Math.floor(Math.random() * chars.length))).join('');
            return phone.slice(-4) + randomPart;
        }

        function updateOnlineStatus() {
            const indicator = document.getElementById('onlineIndicator');
            if (navigator.onLine) {
                indicator.className = 'online-indicator online';
                indicator.querySelector('.indicator-text').textContent = 'Online';
            } else {
                indicator.className = 'online-indicator offline';
                indicator.querySelector('.indicator-text').textContent = 'Offline';
            }
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }

        function retryInitialization() {
            window.location.reload();
        }

        // Event listeners
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
    </script>
    
    <script>
    // Service Worker Registration with Multiple Fallback Paths
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        const swPaths = [
          '/Transparent-Transactions/sw.js',
          './sw.js',
          'sw.js',
          '/sw.js'
        ];
        
        console.log('üõ†Ô∏è Attempting service worker registration...');
        
        let registered = false;
        
        swPaths.forEach(swUrl => {
          if (!registered) {
            navigator.serviceWorker.register(swUrl, {
              scope: '/Transparent-Transactions/'
            })
            .then(function(registration) {
              console.log('‚úÖ ServiceWorker registered successfully:', swUrl);
              registered = true;
            })
            .catch(function(error) {
              console.log('‚ùå ServiceWorker registration failed for', swUrl, error);
            });
          }
        });
      });
    }
    </script>
</body>
</html>
