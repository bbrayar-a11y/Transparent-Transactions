<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transparent Transactions</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: system-ui; background:#f5f7fa; padding:20px; }
    .container { max-width:400px; margin:auto; background:white; padding:30px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#2E8B57; margin-bottom:8px; font-size:24px; }
    .form-input { width:100%; padding:14px; margin:12px 0; border:1px solid #ddd; border-radius:8px; font-size:16px; }
    .btn { width:100%; padding:14px; margin:12px 0; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
    .btn-primary { background:#2E8B57; color:white; }
    .btn-success { background:#28a745; color:white; }
    #db-error { display:none; background:#ffebee; color:#c62828; padding:20px; margin:20px 0; border-radius:8px; text-align:center; }
    #otpSection { display:none; margin-top:20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Transparent Transactions</h1>
    <div id="db-error">Database error. <button onclick="location.reload()">Reload</button></div>
    <div class="phone-form">
      <input type="text" id="name" placeholder="Full Name" class="form-input" />
      <input type="tel" id="phone" placeholder="Phone (10 digits)" class="form-input" maxlength="10" />
      <button id="send" class="btn btn-primary" disabled>Initializing...</button>
    </div>
    <div id="otpSection">
      <input type="text" id="otp" placeholder="Enter 6-digit OTP" class="form-input" maxlength="6" />
      <button id="verify" class="btn btn-success">Verify OTP</button>
    </div>
  </div>

  <script src="js/database.js"></script>
  <script src="js/auth.js"></script>
  <script>
    const sendBtn = document.getElementById('send');
    const otpSec = document.getElementById('otpSection');
    const verifyBtn = document.getElementById('verify');

    // CREATE authManager AFTER DB IS READY
    const initAuth = async () => {
      while (!window.databaseManager?.isInitialized) {
        await new Promise(r => setTimeout(r, 50));
      }
      window.authManager = new AuthManager();
      await window.authManager.init();
      console.log('Auth system ready');
      sendBtn.disabled = false;
      sendBtn.textContent = 'Continue';
    };

    initAuth();

    ['phone', 'otp'].forEach(id => {
      document.getElementById(id).addEventListener('input', e => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, id === 'phone' ? 10 : 6);
      });
    });

    sendBtn.onclick = async () => {
      if (!window.authManager?.isInitialized) return;
      const phone = document.getElementById('phone').value.trim();
      const name = document.getElementById('name').value.trim();
      if (!phone || phone.length !== 10 || !name) {
        window.authManager.showMessage('Invalid input', 'error');
        return;
      }
      sendBtn.disabled = true;
      try {
        const res = await window.authManager.sendOTP(phone);
        if (res.action === 'otp-sent') {
          otpSec.style.display = 'block';
          document.getElementById('otp').focus();
        } else {
          setTimeout(() => location.href = 'dashboard.html', 1000);
        }
      } catch (e) {
        window.authManager.showMessage(e.message || 'Error', 'error');
      } finally {
        sendBtn.disabled = false;
      }
    };

    verifyBtn.onclick = async () => {
      if (!window.authManager?.isInitialized) return;
      const otp = document.getElementById('otp').value.trim();
      if (otp.length !== 6) {
        window.authManager.showMessage('Invalid OTP', 'error');
        return;
      }
      try {
        await window.authManager.verifyOTP(document.getElementById('phone').value, otp, {
          fullName: document.getElementById('name').value
        });
        setTimeout(() => location.href = 'dashboard.html', 1000);
      } catch (e) {
        window.authManager.showMessage(e.message || 'Verification failed', 'error');
      }
    };
  </script>
</body>
</html>
