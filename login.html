<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transparent Transactions</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: system-ui, sans-serif; background:#f5f7fa; padding:20px; }
    .container { max-width:400px; margin:auto; background:white; padding:30px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#2E8B57; margin-bottom:8px; font-size:24px; }
    p { text-align:center; color:#666; font-size:14px; margin-bottom:20px; }
    .form-input { width:100%; padding:14px; margin:12px 0; border:1px solid #ddd; border-radius:8px; font-size:16px; }
    .btn { width:100%; padding:14px; margin:12px 0; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; }
    .btn-primary { background:#2E8B57; color:white; }
    .btn-success { background:#28a745; color:white; }
    #db-error { display:none; background:#ffebee; color:#c62828; padding:20px; margin:20px 0; border-radius:8px; text-align:center; border:1px solid #ffcdd2; }
    #otpSection { display:none; margin-top:20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Transparent Transactions</h1>
    <p>Privacy-first • Offline-first • Revenue-ready</p>

    <div id="db-error">
      <strong>Database Error</strong><br>
      Please reload the page.
      <button onclick="location.reload()" style="margin-top:10px;padding:8px 16px;background:#c62828;color:white;border:none;border-radius:4px;cursor:pointer;">Reload</button>
    </div>

    <div class="phone-form">
      <input type="text" id="fullName" placeholder="Full Name" class="form-input" />
      <input type="tel" id="phone" placeholder="Phone (10 digits)" class="form-input" maxlength="10" />
      <button id="sendBtn" class="btn btn-primary" disabled>Initializing...</button>
    </div>

    <div id="otpSection">
      <input type="text" id="otp" placeholder="Enter 6-digit OTP" class="form-input" maxlength="6" />
      <button id="verifyBtn" class="btn btn-success">Verify OTP</button>
    </div>
  </div>

  <!-- LOAD ONLY database.js -->
  <script src="js/database.js"></script>

  <script>
    const sendBtn = document.getElementById('sendBtn');
    const otpSection = document.getElementById('otpSection');
    const verifyBtn = document.getElementById('verifyBtn');

    // Enable button when auth is ready
    const readyCheck = setInterval(() => {
      if (window.authManager?.isInitialized) {
        clearInterval(readyCheck);
        sendBtn.disabled = false;
        sendBtn.textContent = 'Create Account / Login';
        console.log('UI enabled');
      }
    }, 100);

    sendBtn.onclick = async () => {
      const phone = document.getElementById('phone').value.trim();
      const name = document.getElementById('fullName').value.trim();
      if (!phone || phone.length !== 10 || !name) {
        window.authManager.showMessage('Enter valid name and 10-digit phone', 'error');
        return;
      }
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      try {
        const res = await window.authManager.sendOTP(phone);
        if (res.action === 'otp-sent') {
          otpSection.style.display = 'block';
          document.getElementById('otp').focus();
        } else {
          window.authManager.showMessage('Welcome back!', 'success');
          setTimeout(() => location.href = 'dashboard.html', 1500);
        }
      } catch (err) {
        window.authManager.showMessage(err.message, 'error');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Create Account / Login';
      }
    };

    verifyBtn.onclick = async () => {
      const otp = document.getElementById('otp').value.trim();
      if (otp.length !== 6) return window.authManager.showMessage('Enter 6-digit OTP', 'error');
      verifyBtn.disabled = true;
      try {
        await window.authManager.verifyOTP(
          document.getElementById('phone').value,
          otp,
          { fullName: document.getElementById('fullName').value }
        );
        window.authManager.showMessage('Success! Redirecting...', 'success');
        setTimeout(() => location.href = 'dashboard.html', 1500);
      } catch (err) {
        window.authManager.showMessage(err.message, 'error');
      } finally {
        verifyBtn.disabled = false;
      }
    };

    // Input cleanup
    document.getElementById('phone').addEventListener('input', e => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
    });
    document.getElementById('otp').addEventListener('input', e => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
    });
  </script>
</body>
</html>
